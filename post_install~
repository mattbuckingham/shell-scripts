#!/bin/bash

# check if shell is bash
if [ "$(echo $SHELL)" != "/bin/bash" ]; then
  if command -v chsh >/dev/null 2>&1; then
    echo "Changing shell to bash..."
    chsh -s /bin/bash || { echo "Failed to change shell to bash"; exit 1; }
  else
    echo "chsh command not found. Please manually change your shell to bash."
    exit 1
  fi
fi

# add progress message for unofficial repo
echo "Adding unofficial repo for emacs v28..."
sudo apt-get update > /dev/null || { echo "Failed to update packages"; exit 1; }
#sudo apt-get install software-properties-common -y > /dev/null || { echo "Failed to install software-properties-common"; exit 1; }
sudo add-apt-repository -y ppa:kelleyk/emacs > /dev/null || { echo "Failed to add unofficial repo"; exit 1; }

# System Update and Upgrade
echo "Updating system packages..."
sudo apt-get update > /dev/null || { echo "Failed to update packages"; exit 1; }
#sudo apt-get install --fix-missing -y > /dev/null || { echo "Failed to install missing packages"; exit 1; }
sudo apt-get upgrade --allow-downgrades -y > /dev/null || { echo "Failed to upgrade packages"; exit 1; }

#kill any instances of emacs that are running
pkill emacs

#install essential apps
echo "Installing essential apps..."
sudo apt-get install -y curl git gcc make wget emacs27 python3 python3-pip htop openssh-client rsync netcat > /dev/null || { echo "Failed to install essential apps"; exit 1; }

# Check if .bashrc file exists
if [ ! -e ~/.bashrc ]; then
  # Create blank .bashrc file
  echo "Creating .bashrc file..."
  touch ~/.bashrc || { echo "Failed to create .bashrc file"; exit 1; }
  echo "#!/bin/bash" >> ~/.bashrc
fi

# add aliases to bashrc file
echo "Adding aliases to .bashrc file..."
echo "if [ -f ~/.bash_aliases ]; then" >> ~/.bashrc
echo "  . ~/.bash_aliases" >> ~/.bashrc
echo "fi" >> ~/.bashrc

# download configs from github repo
echo "Downloading configs from GitHub repo..."
curl https://raw.githubusercontent.com/bigBadMatt/shell-scripts/master/alias/.bash_aliases -o ~/.bash_aliases > /dev/null || { echo "Failed to download .bash_aliases file from GitHub"; exit 1; }

# source bash config
echo "Sourcing .bashrc file..."
source ~/.bashrc || { echo "Failed to source .bashrc file"; exit 1; }

# download
echo "Downloading Emacs config file..."
mkdir -p ~/.emacs.d
curl https://raw.githubusercontent.com/bigBadMatt/shell-scripts/master/emacs/init.el -o ~/.emacs.d/init.el > /dev/null || { echo "Failed to download init.el file from GitHub"; exit 1; }

#Clean up
echo "Cleaning up packages..."
sudo apt-get install -f > /dev/null || { echo "Failed to install missing packages"; exit 1; }
sudo apt-get autoremove -y > /dev/null || { echo "Failed to remove unused packages"; exit 1; }
sudo apt-get autoclean > /dev/null || { echo "Failed to clean up packages"; exit 1; }
sudo apt-get clean > /dev/null || { echo "Failed to clean up packages"; exit
